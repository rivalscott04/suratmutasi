import{j as e,av as le,ag as O,_ as H,aE as re,ah as ce,ar as de,a0 as z,a1 as oe,aN as Q,Z as V,Y as me,aY as ue,ae as he}from"./ui-vendor-wOlhVLNZ.js";import{r as c,g as pe,d as xe}from"./react-vendor-C8WR5ETM.js";import{C as G,c as J,a as Y,b as Z}from"./card-VA0GMDSq.js";import{u as X,d as ge,B as b,b as w,a as B,k as ee}from"./index-D62BaAj0.js";import{S as fe,a as je,b as ye,c as be,d as _e}from"./select-BTRk5OJl.js";import{A as Ne,a as we,b as ve,c as ke,d as Se,e as Ae,g as Fe,f as De}from"./alert-dialog-CzXMUGZW.js";const $=o=>String(o).toLowerCase().replace(/[^a-z0-9_-]+/gi,"_").replace(/^_+|_+$/g,""),Pe=({pengajuanId:o,jenisJabatanId:f,onFilesUploaded:v,onProgressChange:r})=>{const{token:g,user:C}=X(),{toast:j}=ge(),[h,q]=c.useState([]),[y,D]=c.useState([]);c.useState([]),c.useState("");const[F,R]=c.useState({}),[P,k]=c.useState(!1),[S,W]=c.useState(!1),[K,L]=c.useState(!0),[M,_]=c.useState(null),U=async()=>{try{L(!0),_(null);let s;if(isNaN(Number(f)))try{const t=await B("/api/job-type-configurations",g);if(t!=null&&t.success&&Array.isArray(t.data)){const i=t.data.find(n=>n.jenis_jabatan===f);if(i)s=i.id;else{_("Jenis jabatan tidak ditemukan");return}}else{_("Gagal mengambil data jenis jabatan");return}}catch{_("Gagal mencari jenis jabatan");return}else s=parseInt(String(f));const a=await B(`/api/admin-wilayah-file-config/job-type/${s}`,g);if(console.log("ðŸ” API Response:",a),console.log("ðŸ” Job Type ID:",s),console.log("ðŸ” Jenis Jabatan ID:",f),a.success){if(console.log("âœ… Setting required files:",a.data),q(a.data),r){const t=y.filter(i=>a.data.some(n=>n.file_type===i.file_type)).length;r(t,a.data.length||0)}}else _("Failed to fetch file configurations")}catch(s){console.error("Error fetching file configs:",s),_("Error connecting to server")}finally{L(!1)}},T=async()=>{var s;try{const a=await B(`/api/admin-wilayah/pengajuan/${o}`,g);if(a!=null&&a.success){const i=(a.uploadedAdminWilayahFiles||((s=a.data)==null?void 0:s.uploadedAdminWilayahFiles)||[]).map(n=>({id:n.id,pengajuan_id:o,file_type:n.file_type,file_name:n.file_name,file_path:n.file_path,file_size:n.file_size,verification_status:n.verification_status||"pending",created_at:n.created_at,updated_at:n.updated_at}));D(i)}else D([])}catch(a){console.error("Error fetching uploaded files:",a),D([])}};c.useEffect(()=>{f&&(U(),T())},[f,g]),c.useEffect(()=>{if(r){const s=h.length,a=y.filter(t=>h.some(i=>i.file_type===t.file_type)).length;r(a,s)}},[h,y]);const E=async(s,a)=>{console.log("ðŸš€ START UPLOAD - fileType:",s,"fileName:",a.name),R(t=>({...t,[s]:!0}));try{console.log("ðŸ” Uploading file:",{fileType:s,fileName:a.name,pengajuanId:o,jenisJabatanId:f,requiredFiles:h.map(n=>({file_type:n.file_type,display_name:n.display_name}))});const t=new FormData;t.append("file",a),t.append("pengajuan_id",o),t.append("file_type",s),t.append("file_category","admin_wilayah"),t.append("uploaded_by_role","admin_wilayah"),t.append("uploaded_by_name",(C==null?void 0:C.full_name)||"Admin Wilayah"),t.append("uploaded_by_office","Kanwil Provinsi"),console.log("ðŸ“¦ FormData created:",{file:a.name,pengajuan_id:o,file_type:s,file_category:"admin_wilayah"});for(let[n,m]of t.entries())console.log("ðŸ“‹ FormData entry:",n,m);const i=await ee(`/api/admin-wilayah/pengajuan/${o}/upload`,t,g);if(i.success){const n={id:i.data.id,pengajuan_id:o,file_type:s,file_name:a.name,file_path:i.data.file_path,file_size:a.size,verification_status:"pending",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},m=[...y,n];if(D(m),v(m),r){const I=h.length,te=m.filter(ie=>h.some(ne=>ne.file_type===ie.file_type)).length;r(te,I)}j({title:"Success",description:`Upload berhasil: ${a.name}`,variant:"default",duration:3e3})}else j({title:"Error",description:i.message||"Gagal upload file",variant:"destructive",duration:3e3})}catch(t){console.error("Error uploading file:",t),j({title:"Error",description:"Gagal upload file",variant:"destructive",duration:3e3})}finally{R(t=>({...t,[s]:!1}))}},l=async()=>{W(!0);try{j({title:"Success",description:"Files submitted for review",variant:"default"}),k(!1)}catch{j({title:"Error",description:"Failed to submit files",variant:"destructive"})}finally{W(!1)}},u=s=>{if(s===0)return"0 Bytes";const a=1024,t=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(s)/Math.log(a));return parseFloat((s/Math.pow(a,i)).toFixed(2))+" "+t[i]},d=s=>{const a=Date.now(),t=new Date(s).getTime(),i=Math.max(0,Math.floor((a-t)/1e3));if(i<5)return"baru saja";if(i<60)return`${i} detik lalu`;const n=Math.floor(i/60);if(n<60)return`${n} menit lalu`;const m=Math.floor(n/60);return m<24?`${m} jam lalu`:`${Math.floor(m/24)} hari lalu`},p=s=>y.find(t=>t.file_type===s)?"uploaded":"pending",x=s=>y.find(a=>a.file_type===s),N=s=>{const{file_type:a,display_name:t}=s;return a==="surat_rekomendasi_kanwil"?"Surat Rekomendasi dari Instansi Pembina - Varian 6.1-6.9":a==="surat_persetujuan_kepala_wilayah"?"Surat Persetujuan Kepala Wilayah - Kemenag Provinsi":a==="surat_pengantar_permohonan_rekomendasi"?"Surat Pengantar - Permohonan Rekomendasi Pindah Tugas":a==="surat_pernyataan_tidak_tugas_belajar"?"Surat Pernyataan - Tidak Sedang Tugas Belajar atau Ikatan Dinas":a==="surat_pernyataan_tidak_hukuman_disiplin"?"Surat Pernyataan - Tidak Sedang Dijatuhi Hukuman Disiplin":a==="surat_pernyataan_tidak_proses_pidana"?"Surat Pernyataan - Tidak Sedang Proses Pidana atau Penjara":a==="surat_pernyataan_tanggung_jawab_mutlak"?"Surat Pernyataan Tanggung Jawab Mutlak (SPTJM)":a==="surat_keterangan_bebas_temuan_inspektorat"?"Surat Keterangan Bebas Temuan (SKBT)":a==="hasil_evaluasi_pertimbangan_baperjakat"?"Hasil Evaluasi dan Pertimbangan (BAPERJAKAT)":a==="surat_rekomendasi_kanwil_khusus"?"Surat Rekomendasi Khusus - Dari Kanwil Provinsi":t},A=async s=>{try{const a=await fetch(`/api/pengajuan/files/${s.id}`,{headers:{Authorization:`Bearer ${g}`}});if(!a.ok)throw new Error("Gagal mengambil file");const t=await a.blob(),i=URL.createObjectURL(t);window.open(i,"_blank"),setTimeout(()=>URL.revokeObjectURL(i),5e3)}catch{j({title:"Error",description:"Gagal membuka preview file",variant:"destructive"})}},ae=async s=>{try{const a=await fetch(`/api/pengajuan/files/${s.id}`,{headers:{Authorization:`Bearer ${g}`}});if(!a.ok)throw new Error("Gagal mengambil file");const t=await a.blob(),i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=s.file_name||"file.pdf",document.body.appendChild(n),n.click(),n.remove(),setTimeout(()=>URL.revokeObjectURL(i),5e3)}catch{j({title:"Error",description:"Gagal mengunduh file",variant:"destructive"})}},se=s=>{const a=document.getElementById(`replace-${$(s)}`);a&&a.click()};return K?e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-1/3"}),e.jsx("div",{className:"space-y-3",children:[...Array(5)].map((s,a)=>e.jsx("div",{className:"h-20 bg-gray-200 rounded"},a))})]})}):M?e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(le,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Error Loading Files"}),e.jsx("p",{className:"text-gray-600 mb-4",children:M}),e.jsxs(b,{onClick:U,className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-4 w-4"}),"Retry"]})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Upload File Admin Wilayah"}),e.jsxs(b,{onClick:()=>{U(),T()},variant:"outline",size:"sm",children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Dokumen Wajib Admin Wilayah"}),e.jsx("div",{className:"text-sm text-gray-600",children:`${h.filter(a=>y.some(t=>t.file_type===a.file_type)).length}/${h.length} berkas sudah diupload`})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:h.map(s=>{console.log("ðŸ”§ Rendering fileConfig:",s);const a=p(s.file_type),t=x(s.file_type);return e.jsx(G,{className:"border border-gray-200",children:e.jsx(J,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:N(s)}),s.is_required&&e.jsx(w,{variant:"destructive",className:"text-[10px] py-0 px-1.5",children:"Wajib"})]}),e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Upload file PDF (maks. ",s.file_type==="skp_2_tahun_terakhir"?"1.6MB":"500KB",")"]}),a==="uploaded"&&t&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium truncate max-w-xs",children:t.file_name}),e.jsxs("span",{className:"text-sm text-gray-500",children:["(",u(t.file_size),")"]}),e.jsxs("span",{className:"text-sm text-gray-500",children:["â€¢ ",d(t.created_at)]})]}),e.jsxs("div",{className:"mt-2 flex gap-2 flex-wrap",children:[e.jsxs(b,{size:"sm",variant:"outline",onClick:()=>A(t),className:"flex items-center gap-1",children:[e.jsx(re,{className:"h-3 w-3"}),"Preview"]}),e.jsxs(b,{size:"sm",variant:"outline",onClick:()=>ae(t),className:"flex items-center gap-1",children:[e.jsx(ce,{className:"h-3 w-3"}),"Download"]}),e.jsxs(b,{size:"sm",variant:"outline",onClick:()=>se(s.file_type),className:"flex items-center gap-1",children:[e.jsx(de,{className:"h-3 w-3"}),"Ganti File"]}),e.jsx("input",{id:`replace-${$(s.file_type)}`,type:"file",className:"hidden",accept:".pdf,.doc,.docx",onChange:i=>{var m;const n=(m=i.target.files)==null?void 0:m[0];n&&(E(s.file_type,n),i.target.value="")}})]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:a==="uploaded"?e.jsxs(w,{className:"bg-green-600 text-white flex items-center gap-1",children:[e.jsx(H,{className:"h-3 w-3"}),"Uploaded"]}):e.jsxs(e.Fragment,{children:[e.jsxs(w,{variant:"secondary",className:"flex items-center gap-1",children:[e.jsx(z,{className:"h-3 w-3"}),"Pending"]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("input",{type:"file",accept:".pdf,.doc,.docx",onChange:i=>{var m;console.log("ðŸ“ File input changed:",i.target.files);const n=(m=i.target.files)==null?void 0:m[0];n?(console.log("ðŸ“„ File selected:",n.name,"fileConfig.file_type:",s.file_type),E(s.file_type,n),i.target.value=""):console.log("âŒ No file selected")},className:"hidden",id:`file-${$(s.file_type)}`}),e.jsx("label",{htmlFor:`file-${$(s.file_type)}`,onClick:()=>{const i=document.getElementById(`file-${$(s.file_type)}`);i&&!i.disabled&&i.click()},children:e.jsxs(b,{disabled:F[s.file_type],size:"sm",className:"h-8 px-3 cursor-pointer bg-green-600 hover:bg-green-700 text-white",children:[F[s.file_type]?e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}):e.jsx(oe,{className:"h-3 w-3 mr-1"}),"Pilih File"]})})]})]})})]})})},s.id)})})]}),(()=>{const s=h.every(a=>y.some(t=>t.file_type===a.file_type));return e.jsx("div",{className:"flex justify-end",children:s?e.jsxs(b,{onClick:()=>k(!0),className:"bg-green-600 hover:bg-green-700",disabled:S,children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Submit for Review"]}):e.jsx("div",{className:"text-sm text-gray-500 text-center",children:"Submit button akan muncul setelah semua berkas wajib diupload"})})})(),e.jsx(Ne,{open:P,onOpenChange:k,children:e.jsxs(we,{children:[e.jsxs(ve,{children:[e.jsx(ke,{children:"Submit Files for Review"}),e.jsx(Se,{children:"Are you sure you want to submit all uploaded files for review? This action cannot be undone."})]}),e.jsxs(Ae,{children:[e.jsx(Fe,{disabled:S,children:"Cancel"}),e.jsx(De,{onClick:l,disabled:S,className:"bg-green-600 hover:bg-green-700",children:S?"Submitting...":"Submit"})]})]})})]})},Be=()=>{var _,U,T,E;const{pengajuanId:o}=pe(),f=xe(),{token:v}=X(),[r,g]=c.useState(null),[C,j]=c.useState(!0),[h,q]=c.useState(!1),[y,D]=c.useState([]),[F,R]=c.useState(""),[P,k]=c.useState({required:0,total:0,isComplete:!1}),S=async()=>{var l,u;if(!(!v||!o)){j(!0);try{const d=await B(`/api/admin-wilayah/pengajuan/${o}`,v);if(d&&d.success!==!1){g(d.pengajuan||((l=d.data)==null?void 0:l.pengajuan)||d);const p=d.uploadProgress||((u=d.data)==null?void 0:u.uploadProgress);if(p){const x=Number(p.required??0),N=Number(p.total??0),A=typeof p.isComplete=="boolean"?p.isComplete:x>=N;k({required:x,total:N,isComplete:A})}else k({required:0,total:0,isComplete:!1})}else g(null),k({required:0,total:0,isComplete:!1})}catch(d){console.error("Failed to fetch pengajuan detail",d),g(null)}finally{j(!1)}}},W=async()=>{try{const l=await B("/api/admin-wilayah-file-config",v);if(l!=null&&l.success&&Array.isArray(l.data)){const u=new Map;l.data.forEach(p=>{var A;const x=p.jenis_jabatan_id,N=((A=p.jenis_jabatan)==null?void 0:A.jenis_jabatan)||`Jabatan ${x}`;x&&!u.has(x)&&u.set(x,N)});const d=Array.from(u.values());D(d),d.length>0&&!F&&R(d[0])}}catch(l){console.error("Failed to fetch job types:",l)}};c.useEffect(()=>{S(),W()},[o,v]);const K=l=>new Date(l).toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),L=(l,u)=>{const d=(p,x)=>{var N;return p!=="submitted"||!x?!1:((N=x.files)==null?void 0:N.some(A=>A.file_category==="admin_wilayah"))||!1};switch(l){case"approved":return e.jsx(w,{className:"bg-green-600 text-white",children:"Disetujui Kab/Kota"});case"admin_wilayah_approved":return e.jsx(w,{className:"bg-green-700 text-white",children:"Disetujui Admin Wilayah"});case"admin_wilayah_rejected":return e.jsx(w,{className:"bg-red-600 text-white",children:"Ditolak Admin Wilayah"});case"submitted":return e.jsx(w,{className:"bg-blue-600 text-white",children:d(l,u)?"Diajukan Admin Wilayah":"Dikirim ke Superadmin"});default:return e.jsx(w,{className:"bg-gray-600 text-white",children:l})}},M=async()=>{if(!(!v||!o)){q(!0);try{await ee(`/api/admin-wilayah/pengajuan/${o}/submit-to-superadmin`,{},v),await S()}finally{q(!1)}}};return C?e.jsx("div",{className:"min-h-screen bg-background p-6",children:e.jsx("div",{className:"max-w-6xl mx-auto",children:e.jsxs("div",{className:"animate-pulse space-y-6",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/3"}),e.jsx("div",{className:"h-64 bg-gray-200 rounded"})]})})}):r?e.jsx("div",{className:"min-h-screen bg-background p-6",children:e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(b,{variant:"outline",onClick:()=>f("/admin-wilayah/dashboard"),className:"border-green-200 text-green-700 hover:bg-green-50",children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Kembali"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Upload File Admin Wilayah"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Upload file tambahan untuk pengajuan mutasi pegawai"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:"bg-green-100 text-green-800",children:"Admin Wilayah"}),L(r.status,r)]})]}),e.jsxs(G,{className:"border-green-200 bg-green-50",children:[e.jsx(Y,{children:e.jsxs(Z,{className:"text-green-800 flex items-center gap-2",children:[e.jsx(z,{className:"h-5 w-5"}),"Informasi Pengajuan"]})}),e.jsx(J,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:((_=r.pegawai)==null?void 0:_.nama)||"-"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["NIP: ",((U=r.pegawai)==null?void 0:U.nip)||"-"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ue,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:((T=r.office)==null?void 0:T.kabkota)||"-"}),e.jsx("p",{className:"text-sm text-gray-600",children:((E=r.office)==null?void 0:E.name)||"-"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:"Jenis Jabatan"}),e.jsx("p",{className:"text-sm text-gray-600",children:r.jenis_jabatan})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(he,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:"Tanggal Pengajuan"}),e.jsx("p",{className:"text-sm text-gray-600",children:K(r.created_at)})]})]})]})]})})]}),e.jsxs(G,{children:[e.jsx(Y,{children:e.jsx(Z,{className:"text-green-800",children:"Upload File Admin Wilayah"})}),e.jsxs(J,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Pilih Jenis Berkas Admin Wilayah"}),e.jsxs(fe,{value:F,onValueChange:R,children:[e.jsx(je,{className:"w-full max-w-md",children:e.jsx(ye,{placeholder:"Pilih jenis berkas..."})}),e.jsx(be,{children:y.map(l=>e.jsx(_e,{value:l,children:l},l))})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Pilih jenis berkas yang sudah dikonfigurasi oleh superadmin"})]}),F&&e.jsx(Pe,{pengajuanId:r.id,jenisJabatanId:F,onFilesUploaded:()=>S(),onProgressChange:(l,u)=>k({required:l,total:u,isComplete:l>=u&&u>0})})]})]}),e.jsx("div",{className:"flex items-center justify-end gap-3",children:(r.status==="approved"||r.status==="submitted")&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"text-sm text-gray-600 mr-2",children:[P.required,"/",P.total," berkas wajib"]}),e.jsxs(b,{onClick:M,disabled:h||r.status==="submitted"||P.required<P.total,className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),r.status==="submitted"?"Sudah Dikirim":"Submit ke Superadmin"]})]})})]})}):e.jsx("div",{className:"min-h-screen bg-background p-6",children:e.jsx("div",{className:"max-w-6xl mx-auto",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(z,{className:"h-16 w-16 mx-auto text-gray-300 mb-4"}),e.jsx("h2",{className:"text-2xl font-semibold text-gray-900 mb-2",children:"Pengajuan Tidak Ditemukan"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Pengajuan yang Anda cari tidak ditemukan atau tidak memiliki akses."}),e.jsxs(b,{onClick:()=>f("/admin-wilayah/dashboard"),className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Kembali ke Dashboard"]})]})})})};export{Be as default};
//# sourceMappingURL=AdminWilayahUploadPage-SAh69RNo.js.map
