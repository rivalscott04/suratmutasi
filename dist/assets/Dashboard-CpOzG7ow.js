import{j as e,a5 as U,T as te,F as p,al as se,am as Ne,an as ne,a3 as ve,ao as De,E as ke,h as _e}from"./ui-vendor-C6CR1JGj.js";import{e as Se,r as u,L as R}from"./react-vendor-B0B9C2fS.js";import{u as Ce,a as _,S as $,B as S,b as C}from"./index-Bl8eCSPV.js";import{C as f,a as b,b as y,c as w}from"./card-DJBMZjiH.js";import{T as re,a as le,b as A,c as h,d as ie,e as o}from"./table-DyfX0bi7.js";import{u as L,w as Ae}from"./xlsx-BEcQbkLY.js";import{P as Le}from"./PageHeader-B89tI5Hu.js";const Ee=()=>{const{user:n,token:g,loading:F}=Ce(),I=Se(),[m,ce]=u.useState([]),[c,H]=u.useState([]),[Y,oe]=u.useState(null),[de,z]=u.useState(!1),[ue,G]=u.useState(!1),[P,he]=u.useState(""),[T,K]=u.useState([]),[M,B]=u.useState(!1),[J,q]=u.useState(!1),O=m.filter(a=>{var t,s,r;return((t=a.letter_number)==null?void 0:t.toLowerCase().includes(P.toLowerCase()))||((s=a.subject)==null?void 0:s.toLowerCase().includes(P.toLowerCase()))||((r=a.template_name)==null?void 0:r.toLowerCase().includes(P.toLowerCase()))});if(u.useEffect(()=>{!F&&!n&&I("/")},[n,F,I]),u.useEffect(()=>{n&&g&&(z(!0),_("/api/letters",g).then(t=>ce(t.letters||[])).catch(t=>oe(t.message||"Gagal fetch surat")).finally(()=>z(!1)),G(!0),_("/api/pengajuan",g).then(t=>{const s=t.data||t.pengajuan||[];H(Array.isArray(s)?s:[])}).catch(()=>H([])).finally(()=>G(!1)),(async()=>{var t;try{B(!0);const s=await _("/api/pengajuan/rekap/aggregate",g),r=((t=s==null?void 0:s.data)==null?void 0:t.aggregation)||(s==null?void 0:s.aggregation)||[];K(Array.isArray(r)?r:[])}catch{K([])}finally{B(!1)}})())},[n,g]),F)return e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen",children:[e.jsx($,{className:"h-8 w-1/2 mb-4"}),e.jsx($,{className:"h-10 w-1/3 mb-2"}),e.jsx($,{className:"h-10 w-1/3 mb-2"}),e.jsx($,{className:"h-10 w-1/3 mb-2"})]});const x=(a,t)=>{if(t===0)return a>0?"+100%":"0%";const s=(a-t)/t*100;return`${s>=0?"+":""}${Math.round(s)}%`},Q=(a,t)=>{const s=new Date;return s.setMonth(s.getMonth()-1),a.filter(r=>{const i=new Date(r[t]);return i.getMonth()===s.getMonth()&&i.getFullYear()===s.getFullYear()})},V=(a,t)=>{const s=new Date;return a.filter(r=>{const i=new Date(r[t]);return i.getMonth()===s.getMonth()&&i.getFullYear()===s.getFullYear()})},X=V(m,"createdAt"),E=Q(m,"createdAt"),Z=V(c,"created_at"),N=Q(c,"created_at"),ee=a=>({draft:"Draf",submitted:"Diajukan",approved:"Disetujui",rejected:"Ditolak Admin Wilayah",resubmitted:"Diajukan Ulang",admin_wilayah_approved:"Disetujui Admin Wilayah",admin_wilayah_rejected:"Ditolak Superadmin",final_approved:"Selesai",final_rejected:"Ditolak Final"})[a]||a.toUpperCase(),ge=async()=>{q(!0);try{let a=[],t=1,s=!0;for(;s;){const d=await _(`/api/pengajuan?page=${t}&limit=100`,g),l=d.data||d.pengajuan||[];l.length===0?s=!1:(a=[...a,...l],t++)}const i=a.map(d=>{var l,D,k;return{Nama:((l=d.pegawai)==null?void 0:l.nama)||"-",Status:ee(d.status),"Kabupaten/Kota":((D=d.office)==null?void 0:D.kabkota)||((k=d.office)==null?void 0:k.name)||"-"}}),pe=T.map(d=>{const l=d.statuses.reduce((D,k)=>(D[k.status]=k.count,D),{});return{"Kabupaten/Kota":d.kabupaten,Draf:l.draft||0,Diajukan:l.submitted||0,Disetujui:l.approved||0,"Ditolak Admin Wilayah":l.rejected||0,"Diajukan Ulang":l.resubmitted||0,"Disetujui Admin Wilayah":l.admin_wilayah_approved||0,"Ditolak Superadmin":l.admin_wilayah_rejected||0,Selesai:l.final_approved||0,"Ditolak Final":l.final_rejected||0,Total:d.total}}),W=L.book_new(),fe=L.json_to_sheet(i);L.book_append_sheet(W,fe,"Data Detail Pengajuan");const be=L.json_to_sheet(pe);L.book_append_sheet(W,be,"Rekap per Kabupaten");const v=new Date,ye=`${v.getFullYear()}${String(v.getMonth()+1).padStart(2,"0")}${String(v.getDate()).padStart(2,"0")}_${String(v.getHours()).padStart(2,"0")}${String(v.getMinutes()).padStart(2,"0")}`,we=`Rekap_Status_${(n==null?void 0:n.role)==="user"?"AdminPusat":"Superadmin"}_${ye}.xlsx`;Ae(W,we)}catch{}finally{q(!1)}},j=(n==null?void 0:n.role)==="bimas",me=j?[{title:"Total Pengajuan",value:c.length,change:x(c.length,N.length),icon:U,color:"text-blue-600"},{title:"Pengajuan Bulan Ini",value:Z.length,change:x(Z.length,N.length),icon:te,color:"text-green-600"},{title:"Disetujui",value:c.filter(a=>a.status==="approved"||a.status==="final_approved").length,change:x(c.filter(a=>a.status==="approved"||a.status==="final_approved").length,N.filter(a=>a.status==="approved"||a.status==="final_approved").length),icon:p,color:"text-green-600"},{title:"Diajukan",value:c.filter(a=>a.status==="submitted"||a.status==="reviewed").length,change:x(c.filter(a=>a.status==="submitted"||a.status==="reviewed").length,N.filter(a=>a.status==="submitted"||a.status==="reviewed").length),icon:se,color:"text-orange-600"}]:[{title:"Total Surat",value:m.length,change:x(m.length,E.length),icon:p,color:"text-blue-600"},{title:"Surat Bulan Ini",value:X.length,change:x(X.length,E.length),icon:te,color:"text-green-600"},{title:"Pengajuan Terbaru",value:c.filter(a=>a.status==="admin_wilayah_submitted").length,change:x(c.filter(a=>a.status==="admin_wilayah_submitted").length,N.filter(a=>a.status==="admin_wilayah_submitted").length),icon:U,color:"text-purple-600"},{title:"Surat Pending",value:m.filter(a=>a.status==="draft").length,change:x(m.filter(a=>a.status==="draft").length,E.filter(a=>a.status==="draft").length),icon:se,color:"text-orange-600"}],ae=Array.from(new Set(m.map(a=>a.template_name))).filter(Boolean),xe=[{title:"Buat Surat Baru",description:"Mulai membuat surat dengan template yang tersedia",icon:p,href:"/generator",color:"bg-blue-500",showForRoles:["admin","operator"]},{title:"Pengajuan",description:"Buat pengajuan jabatan untuk pegawai",icon:U,href:"/pengajuan/select",color:"bg-green-500",showForRoles:["admin","operator"]},{title:"Lihat Laporan",description:"Analisis penggunaan surat",icon:_e,href:"/reports",color:"bg-purple-500",showForRoles:["admin","operator","user"]}],je=a=>a==="generated"?e.jsx(C,{className:"bg-green-100 text-green-700 border-green-200",children:"Generated"}):a==="draft"?e.jsx(C,{className:"bg-orange-100 text-orange-700 border-orange-200",children:"Draft"}):a==="signed"?e.jsx(C,{className:"bg-blue-100 text-blue-700 border-blue-200",children:"Signed"}):e.jsx(C,{className:"bg-gray-100 text-gray-700 border-gray-200",children:a});return e.jsxs("div",{className:"space-y-6",children:[e.jsx(Le,{title:(n==null?void 0:n.role)==="user"?"Dashboard Admin Pusat":(n==null?void 0:n.role)==="bimas"?"Dashboard Bimas":"Dashboard",subtitle:`Selamat datang, ${(n==null?void 0:n.role)==="admin_wilayah"?"Admin Wilayah":(n==null?void 0:n.role)==="admin"?"Administrator Kanwil":(n==null?void 0:n.role)==="operator"?"Operator":(n==null?void 0:n.role)==="user"?"Pengguna":(n==null?void 0:n.role)==="bimas"?"Kanwil Bimas Islam":"Pengguna"}`,showBreadcrumb:!1,actions:e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-gray-500",children:[e.jsx(Ne,{className:"h-4 w-4"}),e.jsx("span",{children:new Date().toLocaleDateString("id-ID",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]})}),e.jsx("div",{className:`grid grid-cols-1 md:grid-cols-2 ${j?"":"lg:grid-cols-4"} gap-6`,children:me.map((a,t)=>{const s=a.icon;return e.jsxs(f,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium text-gray-600",children:a.title}),e.jsx(s,{className:`h-4 w-4 ${a.color}`})]}),e.jsxs(w,{children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:a.value}),e.jsxs("p",{className:"text-xs text-gray-500",children:[e.jsx("span",{className:"text-green-600",children:a.change})," dari bulan lalu"]})]})]},t)})}),!j&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:xe.filter(a=>a.showForRoles.includes((n==null?void 0:n.role)||"")).map((a,t)=>{const s=a.icon;return e.jsxs(f,{className:"hover:shadow-md transition-shadow cursor-pointer",children:[e.jsx(b,{children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${a.color}`,children:e.jsx(s,{className:"h-5 w-5 text-white"})}),e.jsx("div",{children:e.jsx(y,{className:"text-lg",children:a.title})})]})}),e.jsxs(w,{children:[e.jsx("p",{className:"text-gray-600 mb-4",children:a.description}),e.jsx(S,{asChild:!0,variant:"outline",className:"w-full",children:e.jsxs(R,{to:a.href,children:["Akses ",e.jsx(ne,{className:"ml-2 h-4 w-4"})]})})]})]},t)})}),e.jsxs(f,{children:[e.jsx(b,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(y,{className:"text-xl font-semibold",children:j?"Rekap Pengajuan Penghulu & Penyuluh per Kabupaten":"Rekap Status per Kabupaten"}),!j&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(S,{variant:"outline",size:"sm",className:"border-green-200 text-green-700 hover:bg-green-50",disabled:M,onClick:async()=>{var a;if(g)try{B(!0);const t=await _("/api/pengajuan/rekap/aggregate",g),s=((a=t==null?void 0:t.data)==null?void 0:a.aggregation)||(t==null?void 0:t.aggregation)||[];K(Array.isArray(s)?s:[])}finally{B(!1)}},children:[e.jsx(ve,{className:`h-4 w-4 mr-2 ${M?"animate-spin":""}`}),M?"Loading...":"Refresh"]}),e.jsxs(S,{variant:"outline",size:"sm",className:"border-green-200 text-green-700 hover:bg-green-50",disabled:J,onClick:ge,children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),J?"Exporting...":"Export Excel"]})]})]})}),e.jsx(w,{children:M?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Memuat rekap..."}):T.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Tidak ada data"}):(()=>{const a=Array.from(new Set(T.flatMap(t=>t.statuses.map(s=>s.status))));return e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Kabupaten"}),a.map(t=>e.jsx("th",{className:"py-3 pr-4 font-medium whitespace-nowrap text-center",children:(()=>{const s={draft:"Draf",submitted:"Diajukan",approved:"Disetujui",rejected:"Ditolak Admin Wilayah",resubmitted:"Diajukan Ulang",admin_wilayah_approved:"Disetujui Admin Wilayah",admin_wilayah_rejected:"Ditolak Superadmin",admin_wilayah_submitted:"Diajukan Admin Wilayah",final_approved:"Selesai",final_rejected:"Ditolak Final"},r=(t||"").split("_").join(" ").toUpperCase();return s[t]||r})()},t)),e.jsx("th",{className:"py-3 pr-4 font-medium text-center",children:"Total"})]})}),e.jsx("tbody",{children:T.map(t=>{const s=t.statuses.reduce((r,i)=>(r[i.status]=i.count,r),{});return e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"py-3 pr-4 font-medium",children:t.kabupaten}),a.map(r=>e.jsx("td",{className:"py-3 pr-4 text-center",children:s[r]||0},r)),e.jsx("td",{className:"py-3 pr-4 font-semibold text-center",children:t.total})]},t.kabupaten)})})]})})})()})]}),(n==null?void 0:n.role)!=="user"&&!j&&e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:e.jsxs(f,{children:[e.jsx(b,{children:e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(p,{className:"w-5 h-5 text-green-700"})," Jenis Template"]})}),e.jsx(w,{children:e.jsx("div",{className:"space-y-3",children:ae.length===0?e.jsx("div",{className:"text-center text-gray-500",children:"Belum ada template surat"}):ae.map((a,t)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-50 rounded-lg",children:[e.jsx(p,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:a})]},t))})})]})}),j?e.jsxs(f,{className:"mb-4",children:[e.jsx(b,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(y,{className:"text-xl font-semibold",children:"Pengajuan Penghulu & Penyuluh Terbaru"}),e.jsx(S,{asChild:!0,variant:"outline",size:"sm",className:"border-green-200 text-green-700 hover:bg-green-50",children:e.jsxs(R,{to:"/pengajuan",children:["Lihat Semua ",e.jsx(ne,{className:"ml-2 h-4 w-4"})]})})]})}),e.jsx(w,{children:ue?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Memuat pengajuan..."}):c.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Tidak ada pengajuan"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(re,{children:[e.jsx(le,{children:e.jsxs(A,{children:[e.jsx(h,{children:"No."}),e.jsx(h,{children:"Nama Pegawai"}),e.jsx(h,{children:"Jenis Jabatan"}),e.jsx(h,{children:"Kabupaten/Kota"}),e.jsx(h,{children:"Status"}),e.jsx(h,{children:"Aksi"})]})}),e.jsx(ie,{children:c.slice(0,10).map((a,t)=>{var s,r,i;return e.jsxs(A,{children:[e.jsx(o,{children:t+1}),e.jsx(o,{children:((s=a.pegawai)==null?void 0:s.nama)||"-"}),e.jsx(o,{children:a.jenis_jabatan||"-"}),e.jsx(o,{children:((r=a.office)==null?void 0:r.kabkota)||((i=a.office)==null?void 0:i.name)||"-"}),e.jsx(o,{children:e.jsx(C,{className:a.status==="approved"||a.status==="final_approved"?"bg-green-100 text-green-700 border-green-200":a.status==="submitted"||a.status==="reviewed"?"bg-blue-100 text-blue-700 border-blue-200":a.status==="rejected"||a.status==="final_rejected"?"bg-red-100 text-red-700 border-red-200":"bg-gray-100 text-gray-700 border-gray-200",children:ee(a.status)})}),e.jsx(o,{children:e.jsx(S,{asChild:!0,variant:"outline",size:"sm",children:e.jsxs(R,{to:`/pengajuan/${a.id}`,children:[e.jsx(ke,{className:"w-4 h-4 mr-1"})," Detail"]})})})]},a.id)})})]})})})]}):e.jsxs(f,{className:"mb-4",children:[e.jsx(b,{children:e.jsx(y,{className:"text-xl font-semibold",children:"Daftar Surat"})}),e.jsxs(w,{children:[e.jsx("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-2",children:e.jsx("input",{type:"text",className:"input input-bordered w-full md:w-64",placeholder:"Cari nomor, perihal, atau template...",value:P,onChange:a=>he(a.target.value)})}),de?e.jsx("div",{children:"Loading surat..."}):Y?e.jsx("div",{className:"text-error",children:Y}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(re,{children:[e.jsx(le,{children:e.jsxs(A,{children:[e.jsx(h,{children:"No."}),e.jsx(h,{children:"Nomor Surat"}),e.jsx(h,{children:"Perihal"}),e.jsx(h,{children:"Status"}),e.jsx(h,{children:"Aksi"})]})}),e.jsx(ie,{children:O.length===0?e.jsx(A,{children:e.jsx(o,{colSpan:5,className:"text-center",children:"Tidak ada surat"})}):O.slice(0,5).map((a,t)=>e.jsxs(A,{children:[e.jsx(o,{children:t+1}),e.jsx(o,{children:a.letter_number}),e.jsx(o,{children:a.subject}),e.jsx(o,{children:je(a.status)}),e.jsx(o,{children:e.jsxs(R,{to:`/letters/${a.id}`,className:"btn btn-xs btn-outline flex items-center gap-1",children:[e.jsx(p,{className:"w-4 h-4"})," Detail"]})})]},a.id))})]})})]})]})]})};export{Ee as default};
