import{j as e,au as le,aF as J,_ as O,aD as re,ar as ne,ap as ce,a0 as K,a1 as de,aN as Z,Z as H,Y as oe,aY as me,ae as ue}from"./ui-vendor-BCnv6AUJ.js";import{r as c,g as he,d as pe}from"./react-vendor-C8WR5ETM.js";import{C as M,c as I,a as V,b as Y}from"./card-C-04R17C.js";import{u as Q,d as xe,B as j,b as w,a as $,k as X}from"./index-r4qgXIC0.js";import{S as ge,a as fe,b as je,c as ye,d as be}from"./select-fP5pdzKY.js";import{A as Ne,a as we,b as _e,c as ve,d as ke,e as Se,g as Fe,f as Ae}from"./alert-dialog-Bzikk5iR.js";const W=u=>String(u).toLowerCase().replace(/[^a-z0-9_-]+/gi,"_").replace(/^_+|_+$/g,""),De=({pengajuanId:u,jenisJabatanId:_,onFilesUploaded:v,onProgressChange:n})=>{const{token:p,user:U}=Q(),{toast:g}=xe(),[x,B]=c.useState([]),[f,D]=c.useState([]);c.useState([]),c.useState("");const[A,E]=c.useState({}),[P,k]=c.useState(!1),[S,q]=c.useState(!1),[G,z]=c.useState(!0),[L,y]=c.useState(null),C=async()=>{try{z(!0),y(null);let a;if(isNaN(Number(_)))try{const t=await $("/api/job-type-configurations",p);if(t!=null&&t.success&&Array.isArray(t.data)){const i=t.data.find(l=>l.jenis_jabatan===_);if(i)a=i.id;else{y("Jenis jabatan tidak ditemukan");return}}else{y("Gagal mengambil data jenis jabatan");return}}catch{y("Gagal mencari jenis jabatan");return}else a=parseInt(String(_));const s=await $(`/api/admin-wilayah-file-config/job-type/${a}`,p);if(s.success){if(B(s.data),n){const t=f.filter(i=>s.data.some(l=>l.file_type===i.file_type)).length;n(t,s.data.length||0)}}else y("Failed to fetch file configurations")}catch(a){console.error("Error fetching file configs:",a),y("Error connecting to server")}finally{z(!1)}},R=async()=>{var a;try{const s=await $(`/api/admin-wilayah/pengajuan/${u}`,p);if(s!=null&&s.success){const i=(s.uploadedAdminWilayahFiles||((a=s.data)==null?void 0:a.uploadedAdminWilayahFiles)||[]).map(l=>({id:l.id,pengajuan_id:u,file_type:l.file_type,file_name:l.file_name,file_path:l.file_path,file_size:l.file_size,verification_status:l.verification_status||"pending",created_at:l.created_at,updated_at:l.updated_at}));D(i)}else D([])}catch(s){console.error("Error fetching uploaded files:",s),D([])}};c.useEffect(()=>{_&&(C(),R())},[_,p]),c.useEffect(()=>{if(n){const a=x.length,s=f.filter(t=>x.some(i=>i.file_type===t.file_type)).length;n(s,a)}},[x,f]);const T=async(a,s)=>{E(t=>({...t,[a]:!0}));try{const t=new FormData;t.append("file",s),t.append("pengajuan_id",u),t.append("file_type",a),t.append("file_category","admin_wilayah"),t.append("uploaded_by_role","admin_wilayah"),t.append("uploaded_by_name",(U==null?void 0:U.full_name)||"Admin Wilayah"),t.append("uploaded_by_office","Kanwil Provinsi");const i=await X(`/api/admin-wilayah/pengajuan/${u}/upload`,t,p);if(i.success){const l={id:i.data.id,pengajuan_id:u,file_type:a,file_name:s.name,file_path:i.data.file_path,file_size:s.size,verification_status:"pending",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},N=[...f,l];if(D(N),v(N),n){const ae=x.length,se=N.filter(te=>x.some(ie=>ie.file_type===te.file_type)).length;n(se,ae)}g({title:"Success",description:"File berhasil diupload",variant:"default"})}else g({title:"Error",description:i.message||"Gagal upload file",variant:"destructive"})}catch(t){console.error("Error uploading file:",t),g({title:"Error",description:"Gagal upload file",variant:"destructive"})}finally{E(t=>({...t,[a]:!1}))}},r=async()=>{q(!0);try{g({title:"Success",description:"Files submitted for review",variant:"default"}),k(!1)}catch{g({title:"Error",description:"Failed to submit files",variant:"destructive"})}finally{q(!1)}},o=a=>{if(a===0)return"0 Bytes";const s=1024,t=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(a)/Math.log(s));return parseFloat((a/Math.pow(s,i)).toFixed(2))+" "+t[i]},d=a=>f.find(t=>t.file_type===a)?"uploaded":"pending",h=a=>f.find(s=>s.file_type===a),m=a=>{const{file_type:s,display_name:t}=a;return s==="surat_rekomendasi_kanwil"?"Surat Rekomendasi Kanwil - Pindah Tugas Guru/Pengawas":s==="surat_persetujuan_kepala_wilayah"?"Surat Persetujuan Kepala Wilayah - Kemenag Provinsi":s==="surat_pengantar_permohonan_rekomendasi"?"Surat Pengantar - Permohonan Rekomendasi Pindah Tugas":s==="surat_pernyataan_tidak_tugas_belajar"?"Surat Pernyataan - Tidak Sedang Tugas Belajar":s==="surat_pernyataan_tidak_ikatan_dinas"?"Surat Pernyataan - Tidak Sedang Ikatan Dinas":s==="surat_keterangan_kanwil"?"Surat Keterangan - Dari Kanwil Provinsi":s==="surat_rekomendasi_kanwil_khusus"?"Surat Rekomendasi Khusus - Dari Kanwil Provinsi":t},b=async a=>{try{const s=await fetch(`/api/pengajuan/files/${a.id}`,{headers:{Authorization:`Bearer ${p}`}});if(!s.ok)throw new Error("Gagal mengambil file");const t=await s.blob(),i=URL.createObjectURL(t);window.open(i,"_blank"),setTimeout(()=>URL.revokeObjectURL(i),5e3)}catch{g({title:"Error",description:"Gagal membuka preview file",variant:"destructive"})}},F=async a=>{try{const s=await fetch(`/api/pengajuan/files/${a.id}`,{headers:{Authorization:`Bearer ${p}`}});if(!s.ok)throw new Error("Gagal mengambil file");const t=await s.blob(),i=URL.createObjectURL(t),l=document.createElement("a");l.href=i,l.download=a.file_name||"file.pdf",document.body.appendChild(l),l.click(),l.remove(),setTimeout(()=>URL.revokeObjectURL(i),5e3)}catch{g({title:"Error",description:"Gagal mengunduh file",variant:"destructive"})}},ee=a=>{const s=document.getElementById(`replace-${W(a)}`);s&&s.click()};return G?e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-1/3"}),e.jsx("div",{className:"space-y-3",children:[...Array(5)].map((a,s)=>e.jsx("div",{className:"h-20 bg-gray-200 rounded"},s))})]})}):L?e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(le,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Error Loading Files"}),e.jsx("p",{className:"text-gray-600 mb-4",children:L}),e.jsxs(j,{onClick:C,className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),"Retry"]})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Upload File Admin Wilayah"}),e.jsxs(j,{onClick:()=>{C(),R()},variant:"outline",size:"sm",children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Dokumen Wajib Admin Wilayah"}),e.jsx("div",{className:"text-sm text-gray-600",children:`${x.filter(s=>f.some(t=>t.file_type===s.file_type)).length}/${x.length} berkas sudah diupload`})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:x.map(a=>{const s=d(a.file_type),t=h(a.file_type);return e.jsx(M,{className:"border border-gray-200",children:e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:m(a)}),a.is_required&&e.jsx(w,{variant:"destructive",className:"text-[10px] py-0 px-1.5",children:"Wajib"})]}),e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Upload file PDF (maks. ",a.file_type==="skp_2_tahun_terakhir"?"1.6MB":"500KB",")"]}),s==="uploaded"&&t&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[e.jsx(O,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium truncate max-w-xs",children:t.file_name}),e.jsxs("span",{className:"text-sm text-gray-500",children:["(",o(t.file_size),")"]})]}),e.jsxs("div",{className:"mt-2 flex gap-2 flex-wrap",children:[e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>b(t),className:"flex items-center gap-1",children:[e.jsx(re,{className:"h-3 w-3"}),"Preview"]}),e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>F(t),className:"flex items-center gap-1",children:[e.jsx(ne,{className:"h-3 w-3"}),"Download"]}),e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>ee(a.file_type),className:"flex items-center gap-1",children:[e.jsx(ce,{className:"h-3 w-3"}),"Ganti File"]}),e.jsx("input",{id:`replace-${W(a.file_type)}`,type:"file",className:"hidden",accept:".pdf,.doc,.docx",onChange:i=>{var N;const l=(N=i.target.files)==null?void 0:N[0];l&&(T(a.file_type,l),i.target.value="")}})]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:s==="uploaded"?e.jsxs(w,{className:"bg-green-600 text-white flex items-center gap-1",children:[e.jsx(O,{className:"h-3 w-3"}),"Uploaded"]}):e.jsxs(e.Fragment,{children:[e.jsxs(w,{variant:"secondary",className:"flex items-center gap-1",children:[e.jsx(K,{className:"h-3 w-3"}),"Pending"]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("input",{type:"file",accept:".pdf,.doc,.docx",onChange:i=>{var N;const l=(N=i.target.files)==null?void 0:N[0];l&&(T(a.file_type,l),i.target.value="")},className:"hidden",id:`file-${W(a.file_type)}`}),e.jsx("label",{htmlFor:`file-${W(a.file_type)}`,onClick:()=>{const i=document.getElementById(`file-${W(a.file_type)}`);i&&!i.disabled&&i.click()},children:e.jsxs(j,{disabled:A[a.file_type],size:"sm",className:"h-8 px-3 cursor-pointer bg-green-600 hover:bg-green-700 text-white",children:[A[a.file_type]?e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}):e.jsx(de,{className:"h-3 w-3 mr-1"}),"Pilih File"]})})]})]})})]})})},a.id)})})]}),(()=>{const a=x.every(s=>f.some(t=>t.file_type===s.file_type));return e.jsx("div",{className:"flex justify-end",children:a?e.jsxs(j,{onClick:()=>k(!0),className:"bg-green-600 hover:bg-green-700",disabled:S,children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Submit for Review"]}):e.jsx("div",{className:"text-sm text-gray-500 text-center",children:"Submit button akan muncul setelah semua berkas wajib diupload"})})})(),e.jsx(Ne,{open:P,onOpenChange:k,children:e.jsxs(we,{children:[e.jsxs(_e,{children:[e.jsx(ve,{children:"Submit Files for Review"}),e.jsx(ke,{children:"Are you sure you want to submit all uploaded files for review? This action cannot be undone."})]}),e.jsxs(Se,{children:[e.jsx(Fe,{disabled:S,children:"Cancel"}),e.jsx(Ae,{onClick:r,disabled:S,className:"bg-green-600 hover:bg-green-700",children:S?"Submitting...":"Submit"})]})]})})]})},We=()=>{var y,C,R,T;const{pengajuanId:u}=he(),_=pe(),{token:v}=Q(),[n,p]=c.useState(null),[U,g]=c.useState(!0),[x,B]=c.useState(!1),[f,D]=c.useState([]),[A,E]=c.useState(""),[P,k]=c.useState({required:0,total:0,isComplete:!1}),S=async()=>{var r,o;if(!(!v||!u)){g(!0);try{const d=await $(`/api/admin-wilayah/pengajuan/${u}`,v);if(d&&d.success!==!1){p(d.pengajuan||((r=d.data)==null?void 0:r.pengajuan)||d);const h=d.uploadProgress||((o=d.data)==null?void 0:o.uploadProgress);if(h){const m=Number(h.required??0),b=Number(h.total??0),F=typeof h.isComplete=="boolean"?h.isComplete:m>=b;k({required:m,total:b,isComplete:F})}else k({required:0,total:0,isComplete:!1})}else p(null),k({required:0,total:0,isComplete:!1})}catch(d){console.error("Failed to fetch pengajuan detail",d),p(null)}finally{g(!1)}}},q=async()=>{try{const r=await $("/api/admin-wilayah-file-config",v);if(r!=null&&r.success&&Array.isArray(r.data)){const o=new Map;r.data.forEach(h=>{var F;const m=h.jenis_jabatan_id,b=((F=h.jenis_jabatan)==null?void 0:F.jenis_jabatan)||`Jabatan ${m}`;m&&!o.has(m)&&o.set(m,b)});const d=Array.from(o.values());D(d),d.length>0&&!A&&E(d[0])}}catch(r){console.error("Failed to fetch job types:",r)}};c.useEffect(()=>{S(),q()},[u,v]);const G=r=>new Date(r).toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),z=(r,o)=>{const d=(h,m)=>{var b;return h!=="submitted"||!m?!1:((b=m.files)==null?void 0:b.some(F=>F.file_category==="admin_wilayah"))||m.resubmitted_at||m.resubmitted_by};switch(r){case"approved":return e.jsx(w,{className:"bg-green-600 text-white",children:"Disetujui Kab/Kota"});case"admin_wilayah_approved":return e.jsx(w,{className:"bg-green-700 text-white",children:"Disetujui Admin Wilayah"});case"admin_wilayah_rejected":return e.jsx(w,{className:"bg-red-600 text-white",children:"Ditolak Admin Wilayah"});case"submitted":return e.jsx(w,{className:"bg-blue-600 text-white",children:d(r,o)?"Diajukan Admin Wilayah":"Dikirim ke Superadmin"});default:return e.jsx(w,{className:"bg-gray-600 text-white",children:r})}},L=async()=>{if(!(!v||!u)){B(!0);try{await X(`/api/admin-wilayah/pengajuan/${u}/submit-to-superadmin`,{},v),await S()}finally{B(!1)}}};return U?e.jsx("div",{className:"min-h-screen bg-background p-6",children:e.jsx("div",{className:"max-w-6xl mx-auto",children:e.jsxs("div",{className:"animate-pulse space-y-6",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/3"}),e.jsx("div",{className:"h-64 bg-gray-200 rounded"})]})})}):n?e.jsx("div",{className:"min-h-screen bg-background p-6",children:e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(j,{variant:"outline",onClick:()=>_("/admin-wilayah/dashboard"),className:"border-green-200 text-green-700 hover:bg-green-50",children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Kembali"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Upload File Admin Wilayah"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Upload file tambahan untuk pengajuan mutasi pegawai"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:"bg-green-100 text-green-800",children:"Admin Wilayah"}),z(n.status,n)]})]}),e.jsxs(M,{className:"border-green-200 bg-green-50",children:[e.jsx(V,{children:e.jsxs(Y,{className:"text-green-800 flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5"}),"Informasi Pengajuan"]})}),e.jsx(I,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(oe,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:((y=n.pegawai)==null?void 0:y.nama)||"-"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["NIP: ",((C=n.pegawai)==null?void 0:C.nip)||"-"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:((R=n.office)==null?void 0:R.kabkota)||"-"}),e.jsx("p",{className:"text-sm text-gray-600",children:((T=n.office)==null?void 0:T.name)||"-"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:"Jenis Jabatan"}),e.jsx("p",{className:"text-sm text-gray-600",children:n.jenis_jabatan})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ue,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:"Tanggal Pengajuan"}),e.jsx("p",{className:"text-sm text-gray-600",children:G(n.created_at)})]})]})]})]})})]}),e.jsxs(M,{children:[e.jsx(V,{children:e.jsx(Y,{className:"text-green-800",children:"Upload File Admin Wilayah"})}),e.jsxs(I,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Pilih Jenis Berkas Admin Wilayah"}),e.jsxs(ge,{value:A,onValueChange:E,children:[e.jsx(fe,{className:"w-full max-w-md",children:e.jsx(je,{placeholder:"Pilih jenis berkas..."})}),e.jsx(ye,{children:f.map(r=>e.jsx(be,{value:r,children:r},r))})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Pilih jenis berkas yang sudah dikonfigurasi oleh superadmin"})]}),A&&e.jsx(De,{pengajuanId:n.id,jenisJabatanId:A,onFilesUploaded:()=>S(),onProgressChange:(r,o)=>k({required:r,total:o,isComplete:r>=o&&o>0})})]})]}),e.jsx("div",{className:"flex items-center justify-end gap-3",children:(n.status==="approved"||n.status==="submitted")&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"text-sm text-gray-600 mr-2",children:[P.required,"/",P.total," berkas wajib"]}),e.jsxs(j,{onClick:L,disabled:x||n.status==="submitted"||P.required<P.total,className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),n.status==="submitted"?"Sudah Dikirim":"Submit ke Superadmin"]})]})})]})}):e.jsx("div",{className:"min-h-screen bg-background p-6",children:e.jsx("div",{className:"max-w-6xl mx-auto",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(K,{className:"h-16 w-16 mx-auto text-gray-300 mb-4"}),e.jsx("h2",{className:"text-2xl font-semibold text-gray-900 mb-2",children:"Pengajuan Tidak Ditemukan"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Pengajuan yang Anda cari tidak ditemukan atau tidak memiliki akses."}),e.jsxs(j,{onClick:()=>_("/admin-wilayah/dashboard"),className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Kembali ke Dashboard"]})]})})})};export{We as default};
//# sourceMappingURL=AdminWilayahUploadPage-0cTbvzd_.js.map
